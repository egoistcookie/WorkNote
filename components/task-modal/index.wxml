<!--components/task-modal/index.wxml-->
<van-popup
  show="{{show}}"
  position="bottom"
  custom-style="height: 50%; border-radius: 20rpx 20rpx 0 0; background-color: {{themeColors ? themeColors.cardBg : '#F7EBD5'}};"
  bind:close="onClose"
  closeable
  close-icon-position="top-right"
>
  <view class="task-modal theme-{{theme}}">
    <!-- 任务标题 -->
    <view class="modal-header">
      <view class="task-title-wrapper">
        <view class="task-title-badge">
          <view class="title-dot"></view>
          <input
            class="task-title-input"
            value="{{taskTitle}}"
            placeholder="{{selectedCategory}}"
            bindinput="onTitleInput"
            maxlength="50"
          />
        </view>
      </view>
    </view>

    <!-- 新建模式：开始计时按钮 -->
    <view class="start-timer-section" wx:if="{{!isEditMode}}">
      <van-button
        type="primary"
        size="normal"
        custom-color="{{themeColors ? themeColors.accent : '#F6C12C'}}"
        bindtap="onStartTimer"
        class="start-timer-btn"
        custom-style="width: 220rpx; min-width: 220rpx; max-width: 220rpx;"
      >
        <van-icon name="play" size="18px" />
        <text class="button-text">开始计时</text>
      </van-button>
    </view>

    <!-- 编辑模式：开始和结束时间 -->
    <view class="time-section" wx:if="{{isEditMode}}">
      <view class="time-item">
        <view class="time-label">开始时间</view>
        <picker 
          mode="multiSelector" 
          value="{{startTimeArray}}" 
          range="{{timeColumns}}"
          range-key=""
          bindchange="onStartTimeChange"
          bindcolumnchange="onStartTimeColumnChange"
        >
          <view class="time-picker">
            {{startTime || '选择开始时间'}}
            <van-icon name="arrow" size="14px" color="{{themeColors ? themeColors.darkAccent : '#B22A2A'}}" />
          </view>
        </picker>
      </view>
      <view class="time-item">
        <view class="time-label">结束时间</view>
        <picker 
          mode="multiSelector" 
          value="{{endTimeArray}}" 
          range="{{timeColumns}}"
          range-key=""
          bindchange="onEndTimeChange"
          bindcolumnchange="onEndTimeColumnChange"
        >
          <view class="time-picker">
            {{endTime || '选择结束时间'}}
            <van-icon name="arrow" size="14px" color="{{themeColors ? themeColors.darkAccent : '#B22A2A'}}" />
          </view>
        </picker>
      </view>
    </view>

    <!-- 时间段列表（仅在编辑模式且有时间段时显示） -->
    <view class="time-segments-section" wx:if="{{isEditMode && timeSegmentsDisplay.length > 0}}">
      <view class="section-title">时间段</view>
      <view class="time-segments-list">
        <view 
          wx:for="{{timeSegmentsDisplay}}" 
          wx:key="index"
          class="time-segment-item"
        >
          <view class="segment-index">第{{item.index}}段</view>
          <view class="segment-time">
            <text class="segment-start">{{item.startTime}}</text>
            <text class="segment-separator"> - </text>
            <text class="segment-end">{{item.endTime}}</text>
          </view>
          <view class="segment-duration">{{item.duration}}</view>
        </view>
      </view>
    </view>

    <!-- 分类选择 -->
    <view class="category-section">
      <view class="section-title">选择分类</view>
      <view class="category-grid">
        <view
          wx:for="{{categories}}"
          wx:key="label"
          class="category-item {{selectedCategory === item.label ? 'selected' : ''}}"
          style="background-color: {{selectedCategory === item.label ? item.color : (themeColors ? themeColors.primaryBg : '#F0DEBF')}}; border-color: {{selectedCategory === item.label ? item.color : (theme === 'warm' ? 'rgba(246, 193, 44, 0.3)' : 'rgba(89, 139, 176, 0.3)')}}"
          data-category="{{item.label}}"
          bindtap="onCategorySelect"
        >
          {{item.label}}
        </view>
      </view>
    </view>

    <!-- 备注输入 -->
    <view class="note-section">
      <textarea
        value="{{taskNote}}"
        placeholder="≡ 添加备注..."
        bindinput="onNoteInput"
        class="note-textarea"
        maxlength="200"
        auto-height
      />
    </view>

    <!-- 保存和删除按钮 -->
    <view class="save-section">
      <view class="button-group">
        <view wx:if="{{isEditMode}}" class="delete-btn-wrapper">
          <van-button
            type="danger"
            size="normal"
            custom-color="{{themeColors ? themeColors.darkAccent : '#B22A2A'}}"
            bindtap="onDelete"
            class="delete-btn"
            custom-style="width: 220rpx; min-width: 220rpx; max-width: 220rpx;"
          >
            删除
          </van-button>
        </view>
        <view class="save-btn-wrapper">
          <van-button
            type="primary"
            size="normal"
            custom-color="{{themeColors ? themeColors.accent : '#F6C12C'}}"
            bindtap="onSave"
            class="save-btn"
            custom-style="width: 220rpx; min-width: 220rpx; max-width: 220rpx;"
          >
            保存
          </van-button>
        </view>
      </view>
    </view>
  </view>
</van-popup>

