# 微信小程序 TypeScript 开发说明

## 问题：找不到 .js 文件

如果微信开发者工具报错"未找到对应的 .js 文件"，请按以下步骤解决：

### 方案一：手动编译 TypeScript（推荐）

**重要**：微信开发者工具**不支持直接编译 TypeScript**，需要先将 `.ts` 文件编译成 `.js` 文件。

1. **安装 TypeScript 编译器**
   ```bash
   npm install -g typescript
   ```
   或者使用项目本地安装：
   ```bash
   npm install --save-dev typescript
   ```

2. **编译所有 TypeScript 文件**
   在项目根目录运行：
   ```bash
   tsc
   ```
   这会在每个 `.ts` 文件旁边生成对应的 `.js` 文件
   - `pages/timeline/index.ts` → `pages/timeline/index.js`
   - `app.ts` → `app.js`
   - 等等

3. **在微信开发者工具中设置**
   - 打开项目后，点击右上角"详情"
   - 在"本地设置"中：
     - ✅ 确保"将 JS 编译成 ES5"已勾选（通常默认已勾选）
     - ✅ 可以勾选"启用代码自动热重载"方便开发
   - 保存后重新编译

4. **自动编译（开发时推荐）**
   使用 watch 模式，当 `.ts` 文件改变时自动编译：
   ```bash
   tsc --watch
   ```
   保持这个终端窗口打开，每次保存 `.ts` 文件时会自动生成 `.js` 文件

### 方案二：使用 npm 脚本自动编译

项目已配置好编译脚本，可以直接使用：

**编译一次：**
```bash
npm run build
```

**监听模式（推荐开发时使用）：**
```bash
npm run watch
```

这样每次修改 `.ts` 文件后会自动编译成 `.js` 文件。

## 注意事项

1. **文件结构**
   - TypeScript 文件：`pages/timeline/index.ts`
   - 编译后的 JavaScript 文件：`pages/timeline/index.js`
   - 两者应该在同一目录下

2. **Git 忽略**
   - 建议在 `.gitignore` 中添加 `*.js` 和 `*.js.map`
   - 只提交 `.ts` 源文件

3. **微信开发者工具设置**
   - 如果使用手动编译，确保工具不会覆盖你的 .js 文件
   - 可以在"本地设置"中关闭"自动编译"

## 快速开始

1. **首次运行**：
   ```bash
   # 安装依赖（如果需要）
   npm install
   
   # 编译 TypeScript
   npm run build
   ```

2. **开发时**：
   ```bash
   # 在一个终端运行监听模式
   npm run watch
   
   # 然后在微信开发者工具中打开项目
   ```

3. **微信开发者工具设置**：
   - 确保"将 JS 编译成 ES5"已勾选 ✅
   - 可以勾选"启用代码自动热重载" ✅

## 常见问题

**Q: 为什么需要手动编译？**
A: 微信开发者工具不支持直接编译 TypeScript，需要先将 `.ts` 编译成 `.js`。

**Q: 每次都要手动编译吗？**
A: 使用 `npm run watch` 可以自动监听文件变化并编译。

**Q: `.js` 文件需要提交到 Git 吗？**
A: 不需要，`.gitignore` 已配置忽略 `.js` 文件，只提交 `.ts` 源文件。

## 问题：Vant Weapp 组件找不到

如果微信开发者工具报错"未找到组件"或 `getAppConfig error with backend`，通常是未构建 npm 导致的。

### 错误示例

```
getAppConfig error with backend: app.json: ["usingComponents"]["van-button"]: 
"@vant/weapp/button/index"，在 .../miniprogram_npm/@vant/weapp/button/index 路径下未找到组件
```

### 解决方案

**步骤 1：确认依赖已安装**

在项目根目录运行：
```bash
npm install
```

确保 `package.json` 中包含 `@vant/weapp` 依赖。

**步骤 2：在微信开发者工具中构建 npm**

1. 打开微信开发者工具
2. 点击顶部菜单栏 **`工具`** → **`构建 npm`**
3. 等待构建完成（控制台会显示构建成功信息）
4. 构建成功后，项目根目录会生成 `miniprogram_npm` 文件夹

**步骤 3：检查构建结果**

构建成功后，应该能看到：
- `miniprogram_npm/@vant/weapp/button/index.js`
- `miniprogram_npm/@vant/weapp/button/index.json`
- `miniprogram_npm/@vant/weapp/button/index.wxml`
- `miniprogram_npm/@vant/weapp/button/index.wxss`

**步骤 4：重新编译项目**

- 点击微信开发者工具的 **`编译`** 按钮
- 或者使用快捷键 `Ctrl + B`（Windows）或 `Cmd + B`（Mac）

### 注意事项

1. **每次更新 npm 包后都需要重新构建**
   - 如果修改了 `package.json` 或运行了 `npm install`
   - 需要重新执行"构建 npm"操作

2. **构建 npm 的前提条件**
   - 项目根目录必须存在 `package.json` 文件
   - `package.json` 中必须声明了 `@vant/weapp` 依赖
   - 必须已经运行过 `npm install`

3. **如果构建失败**
   - 检查 `node_modules` 目录是否存在
   - 检查 `package.json` 中的依赖是否正确
   - 尝试删除 `miniprogram_npm` 目录后重新构建
   - 尝试删除 `node_modules` 后重新运行 `npm install`

4. **项目配置**
   - 确保 `project.config.json` 中的 `miniprogramRoot` 配置正确（通常为 `"./"`）
   - 确保 `app.json` 中的组件路径正确（如 `"@vant/weapp/button/index"`）

### 常见问题

**Q: 为什么需要构建 npm？**
A: 微信小程序不能直接使用 `node_modules` 中的包，需要通过"构建 npm"将包复制到 `miniprogram_npm` 目录，小程序才能正确引用。

**Q: 构建 npm 后还是找不到组件？**
A: 
- 检查 `app.json` 中的路径是否正确（应该是 `@vant/weapp/button/index`）
- 确认 `miniprogram_npm/@vant/weapp/button/index.js` 文件是否存在
- 尝试重新编译项目
- 检查微信开发者工具版本是否过旧

**Q: 每次都要手动构建吗？**
A: 是的，每次更新 npm 依赖后都需要重新构建。可以在微信开发者工具中设置自动构建（如果支持）。

## 问题：字体文件加载失败（Vant Weapp Icon）

如果微信开发者工具报错"Failed to load font"或 `net::ERR_CACHE_MISS`，通常是 Vant Weapp 的图标组件尝试加载在线字体资源导致的。

### 错误示例

```
[渲染层网络层错误] Failed to load font http://at.alicdn.com/t/c/font_2553510_kfwma2yq1rs.woff2?t=1694918397022
net::ERR_CACHE_MISS
```

### 解决方案

**方案一：在微信开发者工具中关闭域名校验（开发环境，推荐）**

1. 打开微信开发者工具
2. 点击右上角 **`详情`** 按钮
3. 在 **`本地设置`** 标签页中：
   - ✅ 勾选 **`不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书`**
4. 重新编译项目

**方案二：配置域名白名单（生产环境必需）**

如果项目需要发布到生产环境，必须在微信公众平台配置服务器域名：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **`开发`** → **`开发管理`** → **`开发设置`**
3. 在 **`服务器域名`** 中，找到 **`downloadFile 合法域名`**
4. 添加域名：`at.alicdn.com`
5. 保存配置

**方案三：检查项目配置**

确保 `project.config.json` 中包含以下配置（通常已自动配置）：

```json
{
  "setting": {
    "urlCheck": false
  }
}
```

### 注意事项

1. **开发环境 vs 生产环境**
   - 开发环境：使用方案一即可（关闭域名校验）
   - 生产环境：必须使用方案二（配置域名白名单）

2. **为什么会出现这个错误？**
   - Vant Weapp 的 `van-icon` 组件使用 iconfont 字体
   - 字体文件托管在阿里巴巴的 CDN（`at.alicdn.com`）
   - 微信小程序默认不允许加载外部资源，需要配置白名单

3. **这个错误会影响功能吗？**
   - 如果只是字体加载失败，图标可能显示为方块或空白
   - 不影响其他功能，但影响 UI 显示
   - 建议尽快解决

4. **如果关闭域名校验后仍有问题**
   - 检查网络连接是否正常
   - 尝试清除微信开发者工具缓存
   - 重新构建 npm 包
   - 检查微信开发者工具版本是否为最新

### 常见问题

**Q: 为什么 Vant Weapp 要使用在线字体？**
A: Vant Weapp 使用 iconfont 来显示图标，这样可以减少包体积，但需要加载外部字体资源。

**Q: 可以改用本地字体吗？**
A: 可以，但需要修改 Vant Weapp 的源码，比较复杂。建议使用上述方案配置域名白名单。

**Q: 这个错误只在开发环境出现吗？**
A: 不是。如果未配置域名白名单，生产环境也会出现这个错误。开发环境可以通过关闭域名校验来临时解决。

