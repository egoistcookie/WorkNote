<!--pages/timeline/index.wxml-->
<view class="timeline-page theme-{{theme}}">
  <!-- 主题切换按钮 -->
  <view class="theme-toggle-btn" bindtap="onThemeToggle">
    <van-icon name="{{theme === 'warm' ? 'fire' : 'gem'}}" size="20px" color="{{theme === 'warm' ? '#B22A2A' : '#234369'}}" />
  </view>
  
  <calendar 
    selectedDate="{{selectedDate}}"
    theme="{{theme}}"
    bind:datechange="onDateChange"
  />
  
  <log-input
    type="morning"
    title="晨间计划"
    placeholder="点击记录今日计划..."
    icon="sunrise-o"
    value="{{morningLog}}"
    theme="{{theme}}"
    bind:tap="onMorningLogTap"
  />
  
  <!-- 未完成的任务 -->
  <view class="tasks-section" wx:if="{{tasks.length > 0}}">
    <view class="section-title">未完成</view>
    <view 
      wx:for="{{tasks}}" 
      wx:key="id"
    >
      <task-item 
        task="{{item}}"
        selected="{{selectedTaskId === item.id}}"
        theme="{{theme}}"
        bind:tap="onTaskTap"
        bind:detail="onTaskDetail"
      />
    </view>
  </view>
  
  <!-- 按钮（仅在有未完成任务时显示） -->
  <view class="action-buttons-wrapper" wx:if="{{tasks.length > 0 && selectedTask}}">
    <!-- 选中任务是进行状态时，显示暂停按钮 -->
    <van-button 
      wx:if="{{selectedTask.status === 'in_progress'}}"
      type="primary" 
      size="normal"
      custom-color="{{themeColors.darkAccent}}"
      bindtap="onPauseTask"
      class="pause-btn"
      custom-style="background-color: {{themeColors.darkAccent}}; border: none; border-width: 0;"
    >
      <van-icon name="pause" size="18px" />
      <text class="button-text">暂停</text>
    </van-button>
    <!-- 选中任务是暂停或待开始状态时，显示开始按钮 -->
    <van-button 
      wx:if="{{selectedTask.status === 'paused' || selectedTask.status === 'pending'}}"
      type="primary" 
      size="normal"
      custom-color="{{themeColors.accent}}"
      bindtap="onResumeTask"
      class="resume-btn"
    >
      <van-icon name="play" size="18px" />
      <text class="button-text">开始</text>
    </van-button>
    <!-- 完成按钮 -->
    <van-button 
      type="primary" 
      size="normal"
      custom-color="{{themeColors.darkAccent}}"
      bindtap="onCompleteTask"
      class="complete-btn"
    >
      <van-icon name="checked" size="18px" />
      <text class="button-text">完成</text>
    </van-button>
  </view>
  
  <!-- 开始按钮（无未完成任务时显示） -->
  <view class="start-button-wrapper" wx:else>
    <van-button 
      type="primary" 
      size="large"
      custom-color="{{themeColors.accent}}"
      bindtap="onAddTask"
    >
      <van-icon name="plus" size="18px" />
      <text class="button-text">开始</text>
    </van-button>
  </view>
  
  <!-- 已完成的任务 -->
  <view class="completed-tasks-section" wx:if="{{completedTasks.length > 0}}">
    <view class="section-title">已完成</view>
    <view 
      wx:for="{{completedTasks}}" 
      wx:key="id"
    >
      <task-item 
        task="{{item}}"
        theme="{{theme}}"
        bind:tap="onTaskTap"
      />
    </view>
  </view>
  
  <log-input
    type="evening"
    title="夜间总结"
    placeholder="点击记录今日总结..."
    icon="star-o"
    value="{{eveningLog}}"
    theme="{{theme}}"
    bind:tap="onEveningLogTap"
  />
  
  <view class="fab" bindtap="onAddTask">
    <van-icon name="plus" size="24px" color="#fff" />
  </view>
  
  <!-- 任务添加/编辑弹窗 -->
  <task-modal
    show="{{showTaskModal}}"
    task="{{editingTask}}"
    theme="{{theme}}"
    bind:close="onTaskModalClose"
    bind:save="onTaskSave"
    bind:delete="onTaskDelete"
  />

  <!-- 日志编辑弹窗 -->
  <van-popup 
    show="{{showLogModal}}" 
    position="bottom"
    bind:close="onCancelLog"
    custom-style="height: 50%; border-radius: 20rpx 20rpx 0 0; background-color: {{themeColors ? themeColors.cardBg : '#F7EBD5'}};"
  >
    <view class="log-modal">
      <view class="modal-header">
        <text class="modal-title">{{logType === 'morning' ? '晨间计划' : '夜间总结'}}</text>
        <view class="modal-actions">
          <text class="modal-cancel" bindtap="onCancelLog">取消</text>
          <text class="modal-confirm" bindtap="onSaveLog">确定</text>
        </view>
      </view>
      <view class="modal-content">
        <textarea 
          class="log-textarea" 
          value="{{logContent}}"
          placeholder="{{logType === 'morning' ? '请输入晨间计划...' : '请输入夜间总结...'}}"
          bindinput="onLogContentInput"
          maxlength="500"
          auto-height
        />
      </view>
    </view>
  </van-popup>
</view>

